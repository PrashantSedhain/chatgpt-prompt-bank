name: Deploy AWS App Runner (ECR)

on:
  push:
    branches: [main]
    paths:
      - "server/**"
      - "assets/**"
      - "web/**"
      - "Dockerfile"
      - ".dockerignore"
      - ".github/workflows/deploy-apprunner.yml"
  workflow_dispatch: {}

permissions:
  contents: read
  id-token: write

concurrency:
  group: deploy-apprunner-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: us-east-1
      SERVICE_NAME: chatgpt-prompt-bank
      ECR_REPOSITORY: chatgpt-prompt-bank
      IMAGE_TAG: ${{ github.sha }}
      IMAGE_TAG_LATEST: ${{ secrets.IMAGE_TAG_LATEST || 'latest' }}
      WIDGET_VERSION: ${{ github.sha }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: web/package-lock.json

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION || env.AWS_REGION }}

      - name: Resolve deploy configuration
        id: cfg
        shell: bash
        run: |
          set -euo pipefail
          AWS_REGION="${{ secrets.AWS_REGION || env.AWS_REGION }}"
          SERVICE_NAME="${{ secrets.APPRUNNER_SERVICE_NAME || env.SERVICE_NAME }}"
          ECR_REPOSITORY="${{ secrets.ECR_REPOSITORY || env.ECR_REPOSITORY }}"
          echo "aws_region=$AWS_REGION" >> "$GITHUB_OUTPUT"
          echo "service_name=$SERVICE_NAME" >> "$GITHUB_OUTPUT"
          echo "ecr_repository=$ECR_REPOSITORY" >> "$GITHUB_OUTPUT"

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Ensure ECR repository exists
        shell: bash
        env:
          AWS_REGION: ${{ steps.cfg.outputs.aws_region }}
          ECR_REPOSITORY: ${{ steps.cfg.outputs.ecr_repository }}
        run: |
          set -euo pipefail
          if aws ecr describe-repositories --region "$AWS_REGION" --repository-names "$ECR_REPOSITORY" >/dev/null 2>&1; then
            echo "ECR repository exists: $ECR_REPOSITORY"
          else
            echo "Creating ECR repository: $ECR_REPOSITORY"
            aws ecr create-repository --region "$AWS_REGION" --repository-name "$ECR_REPOSITORY" >/dev/null
          fi

      - name: Build widget assets (versioned)
        env:
          WIDGET_VERSION: ${{ env.WIDGET_VERSION }}
        run: |
          set -euo pipefail
          npm ci --prefix web
          WIDGET_VERSION="$WIDGET_VERSION" npm --prefix web run build:widget

      - name: Build and push image
        env:
          REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          REPOSITORY: ${{ steps.cfg.outputs.ecr_repository }}
          IMAGE_TAG: ${{ env.IMAGE_TAG }}
          IMAGE_TAG_LATEST: ${{ env.IMAGE_TAG_LATEST }}
          WIDGET_VERSION: ${{ env.WIDGET_VERSION }}
        run: |
          set -euo pipefail
          docker build \
            --build-arg WIDGET_VERSION="$WIDGET_VERSION" \
            -t "$REGISTRY/$REPOSITORY:$IMAGE_TAG" \
            -t "$REGISTRY/$REPOSITORY:$IMAGE_TAG_LATEST" \
            .
          docker push "$REGISTRY/$REPOSITORY:$IMAGE_TAG"
          docker push "$REGISTRY/$REPOSITORY:$IMAGE_TAG_LATEST"

          echo "pushed_image_sha=$REGISTRY/$REPOSITORY:$IMAGE_TAG" >> "$GITHUB_OUTPUT"
          echo "pushed_image_latest=$REGISTRY/$REPOSITORY:$IMAGE_TAG_LATEST" >> "$GITHUB_OUTPUT"
